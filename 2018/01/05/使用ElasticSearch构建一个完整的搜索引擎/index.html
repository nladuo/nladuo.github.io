<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><script src="http://tx.nladuo.cn:3000/analytics.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><title>使用ElasticSearch构建一个完整的搜索引擎 · 叁公子的博客</title><meta name="description" content="使用ElasticSearch构建一个完整的搜索引擎 - 叁公子"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="../../../../avatar.jpg"><link rel="stylesheet" href="../../../../css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://nladuo.github.io/atom.xml" title="叁公子的博客"></head><body><div class="wrap"><header><a href="../../../../index.html" class="logo-link"><img src="../../../../avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="../../../../index.html" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="../../../../archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/nladuo" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="http://nladuo.github.io/resume" target="_blank" class="nav-list-link">RESUME</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用ElasticSearch构建一个完整的搜索引擎</h1><div class="post-info">Jan 5, 2018</div><div class="post-content"><h2 id="&#x4EFB;&#x52A1;&#x9700;&#x6C42;"><a href="#&#x4EFB;&#x52A1;&#x9700;&#x6C42;" class="headerlink" title="&#x4EFB;&#x52A1;&#x9700;&#x6C42;"></a>&#x4EFB;&#x52A1;&#x9700;&#x6C42;</h2><p>&#x4FE1;&#x606F;&#x68C0;&#x7D22;&#x5BFC;&#x8BBA;&#x8BFE;&#x7684;&#x5927;&#x4F5C;&#x4E1A;&#x8981;&#x6C42;&#x5B8C;&#x6210;&#x4E00;&#x4E2A;&#x641C;&#x7D22;&#x5F15;&#x64CE;&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x641C;&#x7D22;&#x5F15;&#x64CE;&#x7684;&#x9700;&#x6C42;&#x3002;<br><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/command.png" alt=""></p>
<a id="more"></a>
<h2 id="&#x722C;&#x866B;&#x7CFB;&#x7EDF;"><a href="#&#x722C;&#x866B;&#x7CFB;&#x7EDF;" class="headerlink" title="&#x722C;&#x866B;&#x7CFB;&#x7EDF;"></a>&#x722C;&#x866B;&#x7CFB;&#x7EDF;</h2><h4 id="&#x8868;"><a href="#&#x8868;" class="headerlink" title="&#x8868;"></a>&#x8868;</h4><p>&#x6211;&#x4E3B;&#x8981;&#x662F;&#x722C;&#x4E86;&#x7F51;&#x6613;&#x548C;&#x65B0;&#x6D6A;&#x4E24;&#x5927;&#x7F51;&#x7AD9;&#xFF0C;&#x5EFA;&#x4E86;&#x4E24;&#x5F20;&#x8868;&#xFF1A;&#x65B0;&#x95FB;&#x548C;&#x65B0;&#x95FB;&#x8BC4;&#x8BBA;&#x3002;<br><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/table.png" alt=""></p>
<h4 id="news&#x8868;"><a href="#news&#x8868;" class="headerlink" title="news&#x8868;"></a>news&#x8868;</h4><p>&#x4E3B;&#x8981;&#x662F;news&#x7684;url&#x3001;title(&#x6807;&#x9898;)&#x3001;content(&#x6587;&#x7AE0;&#x5185;&#x5BB9;)&#x3001;&#x65F6;&#x95F4;<br><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/news.png" alt=""></p>
<h4 id="comments&#x8868;"><a href="#comments&#x8868;" class="headerlink" title="comments&#x8868;"></a>comments&#x8868;</h4><p>&#x65B0;&#x95FB;&#x548C;&#x65B0;&#x95FB;&#x8BC4;&#x8BBA;&#x662F;&#x4E00;&#x5BF9;&#x591A;&#x7684;&#x5173;&#x7CFB;&#xFF0C;&#x65B0;&#x95FB;&#x8BC4;&#x8BBA;&#x901A;&#x8FC7;&#x65B0;&#x95FB;&#x7684;url&#x548C;&#x65B0;&#x95FB;&#x8868;&#x5173;&#x8054;&#x3002;<br><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/comments.png" alt=""></p>
<h2 id="&#x7D22;&#x5F15;&#x4EE5;&#x5916;&#x7684;&#x529F;&#x80FD;&#x70B9;"><a href="#&#x7D22;&#x5F15;&#x4EE5;&#x5916;&#x7684;&#x529F;&#x80FD;&#x70B9;" class="headerlink" title="&#x7D22;&#x5F15;&#x4EE5;&#x5916;&#x7684;&#x529F;&#x80FD;&#x70B9;"></a>&#x7D22;&#x5F15;&#x4EE5;&#x5916;&#x7684;&#x529F;&#x80FD;&#x70B9;</h2><h4 id="&#x67E5;&#x8BE2;&#x81EA;&#x52A8;&#x8865;&#x9F50;"><a href="#&#x67E5;&#x8BE2;&#x81EA;&#x52A8;&#x8865;&#x9F50;" class="headerlink" title="&#x67E5;&#x8BE2;&#x81EA;&#x52A8;&#x8865;&#x9F50;"></a>&#x67E5;&#x8BE2;&#x81EA;&#x52A8;&#x8865;&#x9F50;</h4><p>&#x4E3B;&#x8981;&#x662F;&#x6839;&#x636E;&#x5386;&#x53F2;&#x641C;&#x7D22;&#x5148;&#x5B9A;&#x4E49;&#x597D;&#xFF0C;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;&#x767E;&#x5EA6;&#x7684;API&#x3002;<br><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/query_append.png" alt=""></p>
<h4 id="&#x8BC4;&#x8BBA;&#x8912;&#x8D2C;&#x5206;&#x6790;"><a href="#&#x8BC4;&#x8BBA;&#x8912;&#x8D2C;&#x5206;&#x6790;" class="headerlink" title="&#x8BC4;&#x8BBA;&#x8912;&#x8D2C;&#x5206;&#x6790;"></a>&#x8BC4;&#x8BBA;&#x8912;&#x8D2C;&#x5206;&#x6790;</h4><ul>
<li>&#x65B9;&#x6848;1&#xFF1A;&#x4F7F;&#x7528;&#x6734;&#x7D20;&#x8D1D;&#x53F6;&#x65AF;&#x5206;&#x7C7B;&#x5668;&#x3002;</li>
<li>&#x65B9;&#x6848;2&#xFF1A;&#x4F7F;&#x7528;&#x4E00;&#x4E2A;&#x4E09;&#x5C42;&#x7684;&#x795E;&#x7ECF;&#x7F51;&#x7EDC;&#xFF0C;&#x2460;Embedding&#x5C42;&#x2461;LSTM&#x2462;&#x5168;&#x8FDE;&#x63A5;&#x7684;sigmoid&#x5C42;&#x3002;</li>
</ul>
<h4 id="&#x76F8;&#x5173;&#x65B0;&#x95FB;&#x63A8;&#x8350;"><a href="#&#x76F8;&#x5173;&#x65B0;&#x95FB;&#x63A8;&#x8350;" class="headerlink" title="&#x76F8;&#x5173;&#x65B0;&#x95FB;&#x63A8;&#x8350;"></a>&#x76F8;&#x5173;&#x65B0;&#x95FB;&#x63A8;&#x8350;</h4><ul>
<li>1.&#x5BF9;&#x6240;&#x6709;&#x65B0;&#x95FB;&#x7684;content&#x5148;TF-IDF&#x3002;</li>
<li>2.&#x5F52;&#x4E00;&#x5316;&#x3002;</li>
<li>3.&#x805A;&#x7C7B;&#x3002;</li>
<li>4.&#x5728;&#x6BCF;&#x4E2A;&#x7C07;&#x4E2D;&#x4F7F;&#x7528;&#x4F59;&#x5F26;&#x76F8;&#x4F3C;&#x5EA6;&#xFF0C;&#x5BF9;&#x6BCF;&#x4E2A;&#x65B0;&#x95FB;&#x627E;&#x51FA;&#x6700;&#x8FD1;&#x7684;K&#x4E2A;&#x65B0;&#x95FB;&#x3002;</li>
</ul>
<h4 id="&#x76F8;&#x5173;&#x641C;&#x7D22;&#x63A8;&#x8350;"><a href="#&#x76F8;&#x5173;&#x641C;&#x7D22;&#x63A8;&#x8350;" class="headerlink" title="&#x76F8;&#x5173;&#x641C;&#x7D22;&#x63A8;&#x8350;"></a>&#x76F8;&#x5173;&#x641C;&#x7D22;&#x63A8;&#x8350;</h4><ul>
<li>&#x5BF9;&#x4E8E;&#x641C;&#x7D22;&#x7ED3;&#x679C;&#x662F;&#x4E00;&#x4E2A;&#x8BCD;&#x7684;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;word2vec&#xFF0C;&#x627E;&#x51FA;&#x8DDD;&#x79BB;&#x6700;&#x8FD1;&#x7684;&#x8BCD;&#x5411;&#x91CF;&#x3002;&#x6BD4;&#x5982;&#x8BF4;&#x641C;&#x7D22;&#x8A79;&#x59C6;&#x65AF;&#xFF0C;&#x4F1A;&#x51FA;&#x6765;&#x79D1;&#x6BD4;&#x3001;JR&#x53F2;&#x5BC6;&#x65AF;&#x7B49;&#x7B49;&#x3002;</li>
<li>&#x5BF9;&#x4E8E;&#x4E00;&#x822C;&#x7684;query&#xFF0C;&#x5BF9;&#x5DF2;&#x6709;&#x7684;&#x7528;&#x6237;query&#x505A;&#x7D22;&#x5F15;&#xFF0C;&#x627E;&#x51FA;&#x8BC4;&#x5206;&#x9AD8;&#x7684;&#x3002;</li>
</ul>
<p>&#x7531;&#x4E8E;&#x6CA1;&#x6709;&#x8BED;&#x6599;&#x5E93;&#xFF0C;&#x8FD9;&#x91CC;&#x5B9E;&#x73B0;&#x76F4;&#x63A5;&#x901A;&#x8FC7;webkit&#x6E32;&#x67D3;js&#x7684;&#x65B9;&#x5F0F;&#x6765;&#x722C;&#x53D6;&#x767E;&#x5EA6;&#x7684;&#x76F8;&#x5173;&#x641C;&#x7D22;&#x3002;</p>
<h2 id="&#x642D;&#x5EFA;ElasticSearch"><a href="#&#x642D;&#x5EFA;ElasticSearch" class="headerlink" title="&#x642D;&#x5EFA;ElasticSearch"></a>&#x642D;&#x5EFA;ElasticSearch</h2><h4 id="&#x5B89;&#x88C5;ES"><a href="#&#x5B89;&#x88C5;ES" class="headerlink" title="&#x5B89;&#x88C5;ES"></a>&#x5B89;&#x88C5;ES</h4><p>&#x8FD9;&#x91CC;&#x9996;&#x5148;&#x5B89;&#x88C5;<a href="http://www.oracle.com/technetwork/java/javase/downloads/index.html" target="_blank" rel="external">JDK</a>&#xFF0C;&#x7136;&#x540E;&#x5B89;&#x88C5;<a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.0.0.zip" target="_blank" rel="external">ElasticSearch-6.0.0</a>&#x7248;&#x672C;&#x3002;</p>
<p>&#x628A;ElasticSearch&#x7684;bin&#x76EE;&#x5F55;&#x6DFB;&#x52A0;&#x5230;PATH&#x4E2D;&#x3002;(&#x4EE5;&#x4E0B;&#x4E3A;linux&#x547D;&#x4EE4;)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> PATH=<span class="variable">$HOME</span>/ProgramFiles/elasticsearch-6.0.0/bin:<span class="variable">${PATH}</span></div></pre></td></tr></table></figure></p>
<h4 id="&#x4F7F;&#x7528;elasticsearch-analysis-ik"><a href="#&#x4F7F;&#x7528;elasticsearch-analysis-ik" class="headerlink" title="&#x4F7F;&#x7528;elasticsearch-analysis-ik"></a>&#x4F7F;&#x7528;elasticsearch-analysis-ik</h4><p>ElasticSearch&#x81EA;&#x5E26;&#x7684;&#x4E2D;&#x6587;&#x5206;&#x8BCD;&#x505A;&#x7684;&#x4E0D;&#x597D;&#xFF0C;&#x6240;&#x4EE5;&#x4F7F;&#x7528;&#x5230;ik&#x7684;&#x4E00;&#x4E2A;&#x63D2;&#x4EF6;&#x3002;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x5B89;&#x88C5;&#x5373;&#x53EF;&#x3002;</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">elasticsearch-plugin install https://github.com/medcl/elasticsearch-analysis-ik/releases/download/v6.0.0/elasticsearch-analysis-ik-6.0.0.zip</div></pre></td></tr></table></figure>
<h4 id="&#x5F00;&#x542F;ElasticSearch&#x670D;&#x52A1;"><a href="#&#x5F00;&#x542F;ElasticSearch&#x670D;&#x52A1;" class="headerlink" title="&#x5F00;&#x542F;ElasticSearch&#x670D;&#x52A1;"></a>&#x5F00;&#x542F;ElasticSearch&#x670D;&#x52A1;</h4><p>&#x5728;&#x547D;&#x4EE4;&#x884C;&#x4E2D;&#x8F93;&#x5165;<code>elasticsearch</code>&#x5373;&#x53EF;&#x5F00;&#x542F;&#x670D;&#x52A1;&#x3002;<br><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/elastic_cli.png" alt=""></p>
<h2 id="&#x7D22;&#x5F15;"><a href="#&#x7D22;&#x5F15;" class="headerlink" title="&#x7D22;&#x5F15;"></a>&#x7D22;&#x5F15;</h2><h4 id="&#x7D22;&#x5F15;&#x5EFA;&#x7ACB;"><a href="#&#x7D22;&#x5F15;&#x5EFA;&#x7ACB;" class="headerlink" title="&#x7D22;&#x5F15;&#x5EFA;&#x7ACB;"></a>&#x7D22;&#x5F15;&#x5EFA;&#x7ACB;</h4><p>&#x5BF9;title&#x548C;content&#x5B57;&#x6BB5;&#x5EFA;&#x7ACB;&#x5206;&#x8BCD;&#x7D22;&#x5F15;&#x3002;<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> elasticsearch <span class="keyword">import</span> Elasticsearch</div><div class="line"><span class="keyword">from</span> db_model <span class="keyword">import</span> DBSession, News, Comment</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line">es = Elasticsearch()</div><div class="line"></div><div class="line"><span class="comment"># &#x521D;&#x59CB;&#x5316;&#x7D22;&#x5F15;&#x7684;Mappings&#x8BBE;&#x7F6E;&#xFF0C;&#x4E09;&#x4E2A;&#x5B57;&#x6BB5;&#xFF0C;&#x65B0;&#x95FB;&#x6807;&#x9898;&#xFF0C;&#x65B0;&#x95FB;&#x5185;&#x5BB9;&#xFF0C;&#x521B;&#x5EFA;&#x65F6;&#x95F4;&#x3002;</span></div><div class="line">index_mappings = {</div><div class="line">  <span class="string">&quot;mappings&quot;</span>: {</div><div class="line">    <span class="string">&quot;news&quot;</span>: {</div><div class="line">      <span class="string">&quot;properties&quot;</span>: {</div><div class="line">        <span class="string">&quot;title&quot;</span>:    {</div><div class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</div><div class="line">            <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</div><div class="line">            <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></div><div class="line">        },</div><div class="line">        <span class="string">&quot;content&quot;</span>:     {</div><div class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;text&quot;</span>,</div><div class="line">            <span class="string">&quot;analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span>,</div><div class="line">            <span class="string">&quot;search_analyzer&quot;</span>: <span class="string">&quot;ik_max_word&quot;</span></div><div class="line">        },</div><div class="line">        <span class="string">&quot;timestamp&quot;</span>: {</div><div class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></div><div class="line">        }</div><div class="line">      }</div><div class="line">    },</div><div class="line">  }</div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">if</span> es.indices.exists(index=<span class="string">&apos;news_index&apos;</span>) <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">True</span>:</div><div class="line">    <span class="keyword">print</span> <span class="string">&quot;create news_index&quot;</span></div><div class="line">    es.indices.create(index=<span class="string">&apos;news_index&apos;</span>, body=index_mappings)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_news</span><span class="params">()</span>:</span>  <span class="comment"># &#x83B7;&#x53D6;&#x65B0;&#x95FB;</span></div><div class="line">    session = DBSession()</div><div class="line">    newses = session.query(News).filter(News.source == source).all()</div><div class="line">    <span class="keyword">for</span> news <span class="keyword">in</span> newses:</div><div class="line">        <span class="keyword">yield</span> news</div><div class="line">    session.close()</div><div class="line"></div><div class="line"><span class="keyword">for</span> i, news <span class="keyword">in</span> enumerate(get_news()):</div><div class="line">    doc = {</div><div class="line">        <span class="string">&quot;id&quot;</span>: news.id,</div><div class="line">        <span class="string">&quot;title&quot;</span>: news.title,</div><div class="line">        <span class="string">&quot;timestamp&quot;</span>: time.mktime(time.strptime(news.time, <span class="string">&apos;%m/%d/%Y %H:%M:%S&apos;</span>)),</div><div class="line">        <span class="string">&quot;content&quot;</span>: news.content,</div><div class="line">    }</div><div class="line">    res = es.index(index=<span class="string">&quot;news_index&quot;</span>, doc_type=<span class="string">&quot;news&quot;</span>, id=news.id, body=doc)</div><div class="line">    <span class="keyword">print</span> res</div></pre></td></tr></table></figure></p>
<h4 id="&#x7D22;&#x5F15;&#x67E5;&#x627E;"><a href="#&#x7D22;&#x5F15;&#x67E5;&#x627E;" class="headerlink" title="&#x7D22;&#x5F15;&#x67E5;&#x627E;"></a>&#x7D22;&#x5F15;&#x67E5;&#x627E;</h4><p>&#x67E5;&#x627E;title&#x548C;content&#x8FD9;&#x4E24;&#x4E2A;&#x5B57;&#x6BB5;&#xFF0C;&#x5E76;&#x663E;&#x793A;snippet&#xFF08;&#x5BF9;&#x4E8E;&#x641C;&#x7D22;&#x5173;&#x952E;&#x8BCD;&#x6807;&#x7EA2;&#xFF09;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x663E;&#x793A;10&#x6761;&#x3002;<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(query)</span>:</span></div><div class="line">    query_contains = {</div><div class="line">        <span class="string">&apos;query&apos;</span>: {</div><div class="line">            <span class="string">&apos;multi_match&apos;</span>: {</div><div class="line">                <span class="string">&apos;query&apos;</span>: query,</div><div class="line">                <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>]</div><div class="line">            }</div><div class="line">        },</div><div class="line">        <span class="string">&quot;highlight&quot;</span>: {</div><div class="line">            <span class="string">&quot;fields&quot;</span>: {</div><div class="line">                <span class="string">&quot;content&quot;</span>: {},</div><div class="line">                <span class="string">&quot;title&quot;</span>: {}</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    es = Elasticsearch()</div><div class="line">    searched = es.search(<span class="string">&quot;news_index&quot;</span>, doc_type=<span class="string">&quot;news&quot;</span>, body=query_contains, size=<span class="number">10</span>)</div><div class="line">    <span class="keyword">return</span> json.dumps(searched)</div></pre></td></tr></table></figure></p>
<h4 id="&#x7D22;&#x5F15;&#x5206;&#x9875;"><a href="#&#x7D22;&#x5F15;&#x5206;&#x9875;" class="headerlink" title="&#x7D22;&#x5F15;&#x5206;&#x9875;"></a>&#x7D22;&#x5F15;&#x5206;&#x9875;</h4><p>&#x76F8;&#x6BD4;&#x7D22;&#x5F15;&#x67E5;&#x627E;&#xFF0C;&#x52A0;&#x4E00;&#x4E2A;offset&#x3002;<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(query, page=<span class="number">1</span>)</span>:</span></div><div class="line">    offset = (page - <span class="number">1</span>) * <span class="number">10</span></div><div class="line">    query_contains = {</div><div class="line">        <span class="string">&apos;query&apos;</span>: {</div><div class="line">            <span class="string">&apos;multi_match&apos;</span>: {</div><div class="line">                <span class="string">&apos;query&apos;</span>: query,</div><div class="line">                <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>]</div><div class="line">            }</div><div class="line">        },</div><div class="line">        <span class="string">&quot;highlight&quot;</span>: {</div><div class="line">            <span class="string">&quot;fields&quot;</span>: {</div><div class="line">                <span class="string">&quot;content&quot;</span>: {},</div><div class="line">                <span class="string">&quot;title&quot;</span>: {}</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    es = Elasticsearch()</div><div class="line">    searched = es.search(<span class="string">&quot;news_index&quot;</span>, doc_type=<span class="string">&quot;news&quot;</span>, body=query_contains, size=<span class="number">10</span>, from_=offset)</div><div class="line">    <span class="keyword">return</span> json.dumps(searched)</div></pre></td></tr></table></figure></p>
<h4 id="&#x7D22;&#x5F15;&#x6392;&#x5E8F;"><a href="#&#x7D22;&#x5F15;&#x6392;&#x5E8F;" class="headerlink" title="&#x7D22;&#x5F15;&#x6392;&#x5E8F;"></a>&#x7D22;&#x5F15;&#x6392;&#x5E8F;</h4><p>&#x6DFB;&#x52A0;sort&#x5B57;&#x6BB5;&#x3002;<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">sort_list = {</div><div class="line">    <span class="string">&quot;0&quot;</span>: [],</div><div class="line">    <span class="string">&quot;1&quot;</span>: [<span class="string">&quot;timestamp:desc&quot;</span>],</div><div class="line">}</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">search</span><span class="params">(query, page=<span class="number">1</span>, sort=[])</span>:</span></div><div class="line">    offset = (page - <span class="number">1</span>) * <span class="number">10</span></div><div class="line">    query_contains = {</div><div class="line">        <span class="string">&apos;query&apos;</span>: {</div><div class="line">            <span class="string">&apos;multi_match&apos;</span>: {</div><div class="line">                <span class="string">&apos;query&apos;</span>: query,</div><div class="line">                <span class="string">&quot;fields&quot;</span>: [<span class="string">&quot;title&quot;</span>, <span class="string">&quot;content&quot;</span>]</div><div class="line">            }</div><div class="line">        },</div><div class="line">        <span class="string">&quot;highlight&quot;</span>: {</div><div class="line">            <span class="string">&quot;fields&quot;</span>: {</div><div class="line">                <span class="string">&quot;content&quot;</span>: {},</div><div class="line">                <span class="string">&quot;title&quot;</span>: {}</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">    es = Elasticsearch()</div><div class="line">    searched = es.search(<span class="string">&quot;news_index&quot;</span>, doc_type=<span class="string">&quot;news&quot;</span>, body=query_contains, size=<span class="number">10</span>, from_=offset,</div><div class="line">                         sort=sort)</div><div class="line">    <span class="keyword">return</span> json.dumps(searched)</div><div class="line"></div><div class="line">search(<span class="string">&quot;&#x8A79;&#x59C6;&#x65AF;&quot;</span>, <span class="number">1</span>, sort_list[<span class="number">1</span>])  <span class="comment"># &#x6309;&#x7167;&#x65F6;&#x95F4;&#x6392;&#x5E8F;</span></div></pre></td></tr></table></figure></p>
<h2 id="&#x6548;&#x679C;"><a href="#&#x6548;&#x679C;" class="headerlink" title="&#x6548;&#x679C;"></a>&#x6548;&#x679C;</h2><p><img src="/2018/01/05/&#x4F7F;&#x7528;ElasticSearch&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x641C;&#x7D22;&#x5F15;&#x64CE;/screenshot.png" alt=""></p>
</div></article></div></main><footer><div class="paginator"><a href="../../09/我把我的心掰成两瓣儿/" class="prev">上一篇</a><a href="../../../../2017/11/09/读论文Alogorithms-for-Non-negative-Matrix-Factorization/" class="next">下一篇</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2018/01/05/使用ElasticSearch构建一个完整的搜索引擎/';
var disqus_title = '使用ElasticSearch构建一个完整的搜索引擎';
var disqus_url = 'http://nladuo.github.io/2018/01/05/使用ElasticSearch构建一个完整的搜索引擎/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2018 <a href="http://nladuo.github.io">叁公子</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>