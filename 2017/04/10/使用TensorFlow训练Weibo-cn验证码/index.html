<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><script src="http://tx.nladuo.cn:3000/analytics.js"></script><script src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><title>使用TensorFlow训练Weibo.cn验证码 · 叁公子的博客</title><meta name="description" content="使用TensorFlow训练Weibo.cn验证码 - 叁公子KCN"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="../../../../avatar.jpg"><link rel="stylesheet" href="../../../../css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://nladuo.github.io/atom.xml" title="叁公子的博客"></head><body><div class="wrap"><header><a href="../../../../index.html" class="logo-link"><img src="../../../../avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="../../../../index.html" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="../../../../archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/nladuo" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">使用TensorFlow训练Weibo.cn验证码</h1><div class="post-info">Apr 10, 2017</div><div class="post-content"><p>&#x6700;&#x8FD1;&#x5728;&#x62BD;&#x65F6;&#x95F4;&#x5B66;&#x4E60;TensorFlow&#x8FD9;&#x4E2A;DL&#x5E93;&#x7684;&#x4F7F;&#x7528;&#xFF0C;&#x5B66;&#x7684;&#x65AD;&#x65AD;&#x7EED;&#x7EED;&#x7684;&#xFF0C;&#x770B;&#x5B98;&#x7F51;&#x4E0A;&#x7B2C;&#x4E00;&#x4E2A;&#x6848;&#x4F8B;&#x5C31;&#x662F;<a href="https://www.tensorflow.org/get_started/mnist/pros" target="_blank" rel="external">&#x8BAD;&#x7EC3;&#x624B;&#x5199;&#x5B57;&#x7B26;&#x8BC6;&#x522B;</a>, &#x6211;&#x4E4B;&#x524D;&#x5728;&#x505A;Weibo.cn&#x9A8C;&#x8BC1;&#x7801;&#x8BC6;&#x522B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x81EA;&#x5DF1;&#x641E;&#x4E86;&#x4E00;&#x4E2A;&#x6570;&#x636E;&#x96C6;&#xFF0C;&#x5F53;&#x65F6;&#x7528;&#x7684;c++&#x5E93;tiny-dnn&#x8FDB;&#x884C;&#x8BAD;&#x7EC3;&#x7684;(&#x89C1;&#xFF1A;<a href="http://nladuo.github.io/2016/09/23/%E9%AA%8C%E8%AF%81%E7%A0%81%E7%A0%B4%E8%A7%A3%E6%8A%80%E6%9C%AF%E5%9B%9B%E9%83%A8%E6%9B%B2%E4%B9%8B%E4%BD%BF%E7%94%A8%E5%8D%B7%E7%A7%AF%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C/">&#x9A8C;&#x8BC1;&#x7801;&#x7834;&#x89E3;&#x6280;&#x672F;&#x56DB;&#x90E8;&#x66F2;&#x4E4B;&#x4F7F;&#x7528;&#x5377;&#x79EF;&#x795E;&#x7ECF;&#x7F51;&#x7EDC;&#xFF08;&#x56DB;&#xFF09;</a>)&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x628A;&#x5B83;&#x79FB;&#x690D;&#x5230;TensorFlow&#x4E0A;&#x8BD5;&#x8BD5;&#x3002;</p>
<p>&#x5B8C;&#x6574;&#x4EE3;&#x7801;&#x89C1;&#xFF1A;<a href="https://github.com/nladuo/captcha-break/tree/master/weibo.cn/tensorflow-impl" target="_blank" rel="external">weibo.cn/tensorflow-impl</a></p>
<h2 id="&#x4F7F;&#x7528;&#x7684;&#x5E93;"><a href="#&#x4F7F;&#x7528;&#x7684;&#x5E93;" class="headerlink" title="&#x4F7F;&#x7528;&#x7684;&#x5E93;"></a>&#x4F7F;&#x7528;&#x7684;&#x5E93;</h2><ul>
<li>TensorFlow-1.0</li>
<li>scikit-learn-0.18</li>
<li>pillow</li>
</ul>
<h2 id="&#x52A0;&#x8F7D;&#x6570;&#x636E;&#x96C6;"><a href="#&#x52A0;&#x8F7D;&#x6570;&#x636E;&#x96C6;" class="headerlink" title="&#x52A0;&#x8F7D;&#x6570;&#x636E;&#x96C6;"></a>&#x52A0;&#x8F7D;&#x6570;&#x636E;&#x96C6;</h2><p>&#x6570;&#x636E;&#x96C6;&#x4E0B;&#x8F7D;&#x5730;&#x5740;&#xFF1A;<a href="https://github.com/nladuo/captcha-break/raw/master/weibo.cn/trainer/training_set.zip" target="_blank" rel="external">training_set.zip</a><br><a id="more"></a></p>
<p>&#x89E3;&#x538B;&#x8FC7;&#x540E;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/dataset.png" alt="dataset"></p>
<p>&#x6211;&#x628A;&#x540C;&#x4E00;&#x7C7B;&#x7684;&#x56FE;&#x7247;&#x653E;&#x5230;&#x4E86;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x91CC;&#xFF0C;&#x6587;&#x4EF6;&#x5939;&#x7684;&#x540D;&#x5B57;&#x4E5F;&#x5C31;&#x662F;&#x56FE;&#x7247;&#x7684;label&#xFF0C;&#x6253;&#x5F00;&#x6587;&#x4EF6;&#x5939;&#x540E;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5B57;&#x7B26;&#x7684;&#x56FE;&#x7247;&#x4FE1;&#x606F;&#x3002;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/dataset_detail.png" alt="dataset_detail"></p>
<p>&#x4E0B;&#x9762;&#xFF0C;&#x6211;&#x4EEC;&#x628A;&#x6570;&#x636E;&#x52A0;&#x8F7D;&#x5230;&#x4E00;&#x4E2A;pickle&#x6587;&#x4EF6;&#x91CC;&#x9762;&#xFF0C;&#x5B83;&#x9700;&#x8981;&#x6709;train_dataset&#x3001;train_labels&#x3001;test_dataset&#x3001;test_labels&#x56DB;&#x4E2A;&#x53D8;&#x91CF;&#x4EE3;&#x8868;&#x8BAD;&#x7EC3;&#x96C6;&#x548C;&#x6D4B;&#x8BD5;&#x96C6;&#x7684;&#x6570;&#x636E;&#x548C;&#x6807;&#x7B7E;&#x3002;</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x6709;&#x4E2A;label_map&#xFF0C;&#x7528;&#x6765;&#x628A;&#x8BAD;&#x7EC3;&#x7684;&#x6807;&#x7B7E;&#x548C;&#x5B9E;&#x9645;&#x7684;&#x6807;&#x7B7E;&#x5BF9;&#x5E94;&#xFF0C;&#x6BD4;&#x5982;&#x8BF4;3&#x5BF9;&#x5E94;&#x5B57;&#x6BCD;M&#xFF0C;4&#x5BF9;&#x5E94;&#x5B57;&#x6BCD;N&#x3002;</p>
<p>&#x6B64;&#x90E8;&#x5206;&#x7684;&#x4EE3;&#x7801;&#x89C1;&#xFF1A;<a href="https://github.com/nladuo/captcha-break/blob/master/weibo.cn/tensorflow-impl/load_models.py" target="_blank" rel="external">load_models.py</a>&#x3002;&#x6CE8;&#xFF1A;&#x5F88;&#x591A;&#x7684;&#x4EE3;&#x7801;&#x53C2;&#x8003;&#x81EA;udacity&#x7684;deeplearning&#x8BFE;&#x7A0B;&#x3002;</p>
<p>&#x9996;&#x5148;&#x6839;&#x636E;&#x6587;&#x4EF6;&#x5939;&#x7684;&#x6765;&#x52A0;&#x8F7D;&#x6240;&#x6709;&#x7684;&#x6570;&#x636E;&#xFF0C;index&#x4EE3;&#x8868;&#x8BAD;&#x7EC3;&#x91CC;&#x7684;&#x6807;&#x7B7E;&#xFF0C;label&#x4EE3;&#x8868;&#x5B9E;&#x9645;&#x7684;&#x6807;&#x7B7E;&#xFF0C;&#x4F7F;&#x7528;PIL&#x8BFB;&#x53D6;&#x56FE;&#x7247;&#xFF0C;&#x5E76;&#x8F6C;&#x6362;&#x6210;numpy&#x6570;&#x7EC4;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_dataset</span><span class="params">()</span>:</span></div><div class="line">    dataset = []</div><div class="line">    labelset = []</div><div class="line">    label_map = {}</div><div class="line"></div><div class="line">    base_dir = <span class="string">&quot;../trainer/training_set/&quot;</span>  <span class="comment"># &#x6570;&#x636E;&#x96C6;&#x7684;&#x4F4D;&#x7F6E;</span></div><div class="line">    labels = os.listdir(base_dir)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> index, label <span class="keyword">in</span> enumerate(labels):</div><div class="line">        <span class="keyword">if</span> label == <span class="string">&quot;ERROR&quot;</span> <span class="keyword">or</span> label == <span class="string">&quot;.DS_Store&quot;</span>:</div><div class="line">            <span class="keyword">continue</span></div><div class="line">        <span class="keyword">print</span> <span class="string">&quot;loading:&quot;</span>, label, <span class="string">&quot;index:&quot;</span>, index</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            image_files = os.listdir(base_dir + label)</div><div class="line">            <span class="keyword">for</span> image_file <span class="keyword">in</span> image_files:</div><div class="line">                image_path = base_dir + label + <span class="string">&quot;/&quot;</span> + image_file</div><div class="line">                im = Image.open(image_path).convert(<span class="string">&apos;L&apos;</span>)</div><div class="line">                dataset.append(np.asarray(im, dtype=np.float32))</div><div class="line">                labelset.append(index)</div><div class="line">            label_map[index] = label</div><div class="line">        <span class="keyword">except</span>: <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> np.array(dataset), np.array(labelset), label_map</div><div class="line"></div><div class="line"></div><div class="line">dataset, labelset, label_map = load_dataset()</div></pre></td></tr></table></figure></p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x628A;&#x6570;&#x636E;&#x6253;&#x4E71;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">randomize</span><span class="params">(dataset, labels)</span>:</span></div><div class="line">    permutation = np.random.permutation(labels.shape[<span class="number">0</span>])</div><div class="line">    shuffled_dataset = dataset[permutation, :, :]</div><div class="line">    shuffled_labels = labels[permutation]</div><div class="line">    <span class="keyword">return</span> shuffled_dataset, shuffled_labels</div><div class="line"></div><div class="line"></div><div class="line">dataset, labelset = randomize(dataset, labelset)</div></pre></td></tr></table></figure></p>
<p>&#x7136;&#x540E;&#x4F7F;&#x7528;scikit-learn&#x7684;&#x51FD;&#x6570;&#xFF0C;&#x628A;&#x8BAD;&#x7EC3;&#x96C6;&#x548C;&#x6D4B;&#x8BD5;&#x96C6;&#x5206;&#x5F00;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</div><div class="line">train_dataset, test_dataset, train_labels, test_labels = train_test_split(dataset, labelset)</div></pre></td></tr></table></figure></p>
<p>&#x5728;TensorFlow&#x5B98;&#x7F51;&#x7ED9;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;&#x4F1A;&#x628A;label&#x8FDB;&#x884C;<code>One-Hot Encoding</code>&#xFF0C;&#x5E76;&#x628A;28*28&#x7684;&#x56FE;&#x7247;&#x8F6C;&#x6362;&#x6210;&#x4E86;&#x4E00;&#x7EF4;&#x5411;&#x91CF;(784)&#x3002;&#x5982;&#x4E0B;&#x56FE;&#xFF0C;&#x67E5;&#x770B;&#x5B98;&#x7F51;&#x4F8B;&#x5B50;&#x7684;&#x6A21;&#x578B;&#x3002;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/minist_data.png" alt="minist_data"></p>
<p>&#x6211;&#x4E5F;&#x628A;&#x6570;&#x636E;&#x8F6C;&#x6362;&#x4E86;&#x4E00;&#x4E0B;&#xFF0C;&#x628A;32*32&#x7684;&#x56FE;&#x7247;&#x8F6C;&#x6362;&#x6210;&#x4E00;&#x7EF4;&#x5411;&#x91CF;(1024)&#xFF0C;&#x5E76;&#x5BF9;&#x6807;&#x7B7E;&#x8FDB;&#x884C;One-Hot Encoding&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">reformat</span><span class="params">(dataset, labels, image_size, num_labels)</span>:</span></div><div class="line">    dataset = dataset.reshape((<span class="number">-1</span>, image_size * image_size)).astype(np.float32)</div><div class="line">    <span class="comment"># Map 1 to [0.0, 1.0, 0.0 ...], 2 to [0.0, 0.0, 1.0 ...]</span></div><div class="line">    labels = (np.arange(num_labels) == labels[:, <span class="keyword">None</span>]).astype(np.float32)</div><div class="line">    <span class="keyword">return</span> dataset, labels</div><div class="line"></div><div class="line">train_dataset, train_labels = reformat(train_dataset, train_labels, <span class="number">32</span>, len(label_map))</div><div class="line">test_dataset, test_labels = reformat(test_dataset, test_labels, <span class="number">32</span>, len(label_map))</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;train_dataset:&quot;</span>, train_dataset.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;train_labels:&quot;</span>, train_labels.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;test_dataset:&quot;</span>, test_dataset.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;test_labels:&quot;</span>, test_labels.shape</div></pre></td></tr></table></figure></p>
<p>&#x8F6C;&#x6362;&#x540E;&#xFF0C;&#x683C;&#x5F0F;&#x5C31;&#x548C;minist&#x4E00;&#x6837;&#x4E86;&#x3002;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/reformat.png" alt="reformat"></p>
<p>&#x6700;&#x540E;&#xFF0C;&#x628A;&#x6570;&#x636E;&#x4FDD;&#x5B58;&#x5230;save.pickle&#x91CC;&#x9762;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">save = {</div><div class="line">    <span class="string">&apos;train_dataset&apos;</span>: train_dataset,</div><div class="line">    <span class="string">&apos;train_labels&apos;</span>: train_labels,</div><div class="line">    <span class="string">&apos;test_dataset&apos;</span>: test_dataset,</div><div class="line">    <span class="string">&apos;test_labels&apos;</span>: test_labels,</div><div class="line">    <span class="string">&apos;label_map&apos;</span>: label_map</div><div class="line">}</div><div class="line"><span class="keyword">with</span> open(<span class="string">&quot;save.pickle&quot;</span>, <span class="string">&apos;wb&apos;</span>) <span class="keyword">as</span> f:</div><div class="line">    pickle.dump(save, f)</div></pre></td></tr></table></figure></p>
<h2 id="&#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;&#x52A0;&#x8F7D;&#x662F;&#x5426;&#x6B63;&#x786E;"><a href="#&#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;&#x52A0;&#x8F7D;&#x662F;&#x5426;&#x6B63;&#x786E;" class="headerlink" title="&#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;&#x52A0;&#x8F7D;&#x662F;&#x5426;&#x6B63;&#x786E;"></a>&#x9A8C;&#x8BC1;&#x6570;&#x636E;&#x96C6;&#x52A0;&#x8F7D;&#x662F;&#x5426;&#x6B63;&#x786E;</h2><p>&#x52A0;&#x8F7D;&#x5B8C;&#x6570;&#x636E;&#x540E;&#xFF0C;&#x9700;&#x8981;&#x9A8C;&#x8BC1;&#x4E00;&#x4E0B;&#x6570;&#x636E;&#x662F;&#x5426;&#x6B63;&#x786E;&#x3002;&#x6211;&#x9009;&#x62E9;&#x7684;&#x65B9;&#x6CD5;&#x5F88;&#x7B80;&#x5355;&#xFF0C;&#x5C31;&#x662F;&#x628A;trainset&#x7684;&#x7B2C;1&#x4E2A;(&#x6216;&#x8005;&#x7B2C;2&#x4E2A;&#x3001;&#x7B2C;n&#x4E2A;)&#x56FE;&#x7247;&#x6253;&#x5F00;&#xFF0C;&#x770B;&#x770B;&#x5B83;&#x7684;&#x6807;&#x7B7E;&#x548C;&#x770B;&#x5230;&#x7684;&#x80FD;&#x4E0D;&#x80FD;&#x5BF9;&#x4E0A;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> cPickle <span class="keyword">as</span> pickle</div><div class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_dataset</span><span class="params">(dataset, labels, label_map, index)</span>:</span></div><div class="line">    data = np.uint8(dataset[index]).reshape((<span class="number">32</span>, <span class="number">32</span>))</div><div class="line">    i = np.argwhere(labels[index] == <span class="number">1</span>)[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">    im = Image.fromarray(data)</div><div class="line">    im.show()</div><div class="line">    <span class="keyword">print</span> <span class="string">&quot;label:&quot;</span>, label_map[i]</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">&apos;__main__&apos;</span>:</div><div class="line">    <span class="keyword">with</span> open(<span class="string">&quot;save.pickle&quot;</span>, <span class="string">&apos;rb&apos;</span>) <span class="keyword">as</span> f:</div><div class="line">        save = pickle.load(f)</div><div class="line">        train_dataset = save[<span class="string">&apos;train_dataset&apos;</span>]</div><div class="line">        train_labels = save[<span class="string">&apos;train_labels&apos;</span>]</div><div class="line">        test_dataset = save[<span class="string">&apos;test_dataset&apos;</span>]</div><div class="line">        test_labels = save[<span class="string">&apos;test_labels&apos;</span>]</div><div class="line">        label_map = save[<span class="string">&apos;label_map&apos;</span>]</div><div class="line"></div><div class="line">	<span class="comment"># check if the image is corresponding to it&apos;s label</span></div><div class="line">	check_dataset(train_dataset, train_labels, label_map, <span class="number">0</span>)</div></pre></td></tr></table></figure></p>
<p>&#x8FD0;&#x884C;&#x540E;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x7B2C;&#x4E00;&#x5F20;&#x56FE;&#x7247;&#x662F;Y&#xFF0C;&#x6807;&#x7B7E;&#x4E5F;&#x662F;&#x6B63;&#x786E;&#x7684;&#x3002;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/check_dataset.png" alt="check_dataset"></p>
<h2 id="&#x8BAD;&#x7EC3;"><a href="#&#x8BAD;&#x7EC3;" class="headerlink" title="&#x8BAD;&#x7EC3;"></a>&#x8BAD;&#x7EC3;</h2><p>&#x6570;&#x636E;&#x52A0;&#x8F7D;&#x597D;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x5F00;&#x59CB;&#x8BAD;&#x7EC3;&#x4E86;&#xFF0C;&#x8BAD;&#x7EC3;&#x7684;&#x7F51;&#x7EDC;&#x5C31;&#x4F7F;&#x7528;TensorFlow&#x5B98;&#x7F51;&#x5728;<a href="https://www.tensorflow.org/get_started/mnist/pros" target="_blank" rel="external">Deep MNIST for Experts</a>&#x91CC;&#x63D0;&#x4F9B;&#x7684;&#x5C31;&#x597D;&#x4E86;&#x3002;</p>
<p>&#x6B64;&#x90E8;&#x5206;&#x7684;&#x4EE3;&#x7801;&#x89C1;&#xFF1A;<a href="https://github.com/nladuo/captcha-break/blob/master/weibo.cn/tensorflow-impl/train.py" target="_blank" rel="external">train.py</a>&#x3002;</p>
<p>&#x5148;&#x52A0;&#x8F7D;&#x4E00;&#x4E0B;&#x6A21;&#x578B;:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> cPickle <span class="keyword">as</span> pickle</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</div><div class="line"></div><div class="line"><span class="keyword">with</span> open(<span class="string">&quot;save.pickle&quot;</span>, <span class="string">&apos;rb&apos;</span>) <span class="keyword">as</span> f:</div><div class="line">    save = pickle.load(f)</div><div class="line">    train_dataset = save[<span class="string">&apos;train_dataset&apos;</span>]</div><div class="line">    train_labels = save[<span class="string">&apos;train_labels&apos;</span>]</div><div class="line">    test_dataset = save[<span class="string">&apos;test_dataset&apos;</span>]</div><div class="line">    test_labels = save[<span class="string">&apos;test_labels&apos;</span>]</div><div class="line">    label_map = save[<span class="string">&apos;label_map&apos;</span>]</div><div class="line"></div><div class="line">image_size = <span class="number">32</span></div><div class="line">num_labels = len(label_map)</div><div class="line"></div><div class="line"><span class="keyword">print</span> <span class="string">&quot;train_dataset:&quot;</span>, train_dataset.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;train_labels:&quot;</span>, train_labels.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;test_dataset:&quot;</span>, test_dataset.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;test_labels:&quot;</span>, test_labels.shape</div><div class="line"><span class="keyword">print</span> <span class="string">&quot;num_labels:&quot;</span>, num_labels</div></pre></td></tr></table></figure></p>
<p>minist&#x7684;&#x6570;&#x636E;&#x90FD;&#x662F;28*28&#x7684;&#xFF0C;&#x628A;&#x91CC;&#x9762;&#x7684;&#x7F51;&#x7EDC;&#x6539;&#x5B8C;&#x4E86;&#x4E4B;&#x540E;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">weight_variable</span><span class="params">(shape)</span>:</span></div><div class="line">    initial = tf.truncated_normal(shape, stddev=<span class="number">0.1</span>)</div><div class="line">    <span class="keyword">return</span> tf.Variable(initial)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">bias_variable</span><span class="params">(shape)</span>:</span></div><div class="line">    initial = tf.constant(<span class="number">0.1</span>, shape=shape)</div><div class="line">    <span class="keyword">return</span> tf.Variable(initial)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">conv2d</span><span class="params">(x, W)</span>:</span></div><div class="line">    <span class="keyword">return</span> tf.nn.conv2d(x, W, strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>], padding=<span class="string">&apos;SAME&apos;</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">max_pool_2x2</span><span class="params">(x)</span>:</span></div><div class="line">    <span class="keyword">return</span> tf.nn.max_pool(x, ksize=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>],</div><div class="line">                          strides=[<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>], padding=<span class="string">&apos;SAME&apos;</span>)</div><div class="line"></div><div class="line"></div><div class="line">graph = tf.Graph()</div><div class="line"><span class="keyword">with</span> graph.as_default():</div><div class="line">    x = tf.placeholder(tf.float32, shape=[<span class="keyword">None</span>, image_size * image_size])</div><div class="line">    y_ = tf.placeholder(tf.float32, shape=[<span class="keyword">None</span>, num_labels])</div><div class="line"></div><div class="line">    x_image = tf.reshape(x, [<span class="number">-1</span>, <span class="number">32</span>, <span class="number">32</span>, <span class="number">1</span>])</div><div class="line"></div><div class="line">    <span class="comment"># First Convolutional Layer</span></div><div class="line">    W_conv1 = weight_variable([<span class="number">5</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">32</span>])</div><div class="line">    b_conv1 = bias_variable([<span class="number">32</span>])</div><div class="line"></div><div class="line">    h_conv1 = tf.nn.relu(conv2d(x_image, W_conv1) + b_conv1)</div><div class="line">    h_pool1 = max_pool_2x2(h_conv1)</div><div class="line"></div><div class="line">    <span class="comment"># Second Convolutional Layer</span></div><div class="line">    W_conv2 = weight_variable([<span class="number">5</span>, <span class="number">5</span>, <span class="number">32</span>, <span class="number">64</span>])</div><div class="line">    b_conv2 = bias_variable([<span class="number">64</span>])</div><div class="line"></div><div class="line">    h_conv2 = tf.nn.relu(conv2d(h_pool1, W_conv2) + b_conv2)</div><div class="line">    h_pool2 = max_pool_2x2(h_conv2)</div><div class="line"></div><div class="line">    <span class="comment"># Densely Connected Layer</span></div><div class="line">    W_fc1 = weight_variable([image_size / <span class="number">4</span> * image_size / <span class="number">4</span> * <span class="number">64</span>, <span class="number">1024</span>])</div><div class="line">    b_fc1 = bias_variable([<span class="number">1024</span>])</div><div class="line"></div><div class="line">    h_pool2_flat = tf.reshape(h_pool2, [<span class="number">-1</span>, image_size / <span class="number">4</span> * image_size / <span class="number">4</span> * <span class="number">64</span>])</div><div class="line">    h_fc1 = tf.nn.relu(tf.matmul(h_pool2_flat, W_fc1) + b_fc1)</div><div class="line"></div><div class="line">    <span class="comment"># Dropout</span></div><div class="line">    keep_prob = tf.placeholder(tf.float32)</div><div class="line">    h_fc1_drop = tf.nn.dropout(h_fc1, keep_prob)</div><div class="line"></div><div class="line">    <span class="comment"># Readout Layer</span></div><div class="line">    W_fc2 = weight_variable([<span class="number">1024</span>, num_labels])</div><div class="line">    b_fc2 = bias_variable([num_labels])</div><div class="line"></div><div class="line">    y_conv = tf.matmul(h_fc1_drop, W_fc2) + b_fc2</div><div class="line"></div><div class="line">    cross_entropy = tf.reduce_mean(</div><div class="line">        tf.nn.softmax_cross_entropy_with_logits(labels=y_, logits=y_conv))</div><div class="line"></div><div class="line">    train_step = tf.train.AdamOptimizer(<span class="number">1e-4</span>).minimize(cross_entropy)</div><div class="line">    correct_prediction = tf.equal(tf.argmax(y_conv, <span class="number">1</span>), tf.argmax(y_, <span class="number">1</span>))</div><div class="line">    accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</div></pre></td></tr></table></figure></p>
<p>&#x4E3B;&#x8981;&#x6539;&#x52A8;&#x5C31;&#x662F;&#x8F93;&#x5165;&#x5C42;&#x628A;28*28&#x6539;&#x6210;&#x4E86;image_size*image_size&#xFF08;32*32&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x7B2C;&#x4E09;&#x5C42;&#x7684;&#x5168;&#x8FDE;&#x63A5;&#x7F51;&#x7EDC;&#x628A;7*7&#x6539;&#x6210;&#x4E86;image_size/4*image_size/4&#xFF08;8*8&#xFF09;&#xFF0C;&#x4EE5;&#x53CA;&#x628A;10&#xFF08;&#x624B;&#x5199;&#x5B57;&#x7B26;&#x4E00;&#x5171;10&#x7C7B;&#xFF09;&#x6539;&#x6210;&#x4E86;num_labels&#x3002;</p>
<p>&#x7136;&#x540E;&#x8BAD;&#x7EC3;&#xFF0C;&#x6211;&#x8FD9;&#x91CC;&#x628A;batch_size&#x6539;&#x6210;&#x4E86;128&#xFF0C;&#x8BAD;&#x7EC3;&#x6279;&#x6B21;&#x6539;&#x5C11;&#x4E86;&#x3002;<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">batch_size = <span class="number">128</span></div><div class="line"><span class="keyword">with</span> tf.Session(graph=graph) <span class="keyword">as</span> session:</div><div class="line">    tf.global_variables_initializer().run()</div><div class="line">    print(<span class="string">&quot;Initialized&quot;</span>)</div><div class="line"></div><div class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> range(<span class="number">2001</span>):</div><div class="line">        offset = (step * batch_size) % (train_labels.shape[<span class="number">0</span>] - batch_size)</div><div class="line">        <span class="comment"># Generate a minibatch.</span></div><div class="line">        batch_data = train_dataset[offset:(offset + batch_size), :]</div><div class="line">        batch_labels = train_labels[offset:(offset + batch_size), :]</div><div class="line"></div><div class="line">        <span class="keyword">if</span> step % <span class="number">50</span> == <span class="number">0</span>:</div><div class="line">            train_accuracy = accuracy.eval(feed_dict={</div><div class="line">                x: batch_data, y_: batch_labels, keep_prob: <span class="number">1.0</span>})</div><div class="line">            test_accuracy = accuracy.eval(feed_dict={</div><div class="line">                x: test_dataset, y_: test_labels, keep_prob: <span class="number">1.0</span>})</div><div class="line">            print(<span class="string">&quot;Step %d, Training accuracy: %g, Test accuracy: %g&quot;</span> % (step, train_accuracy, test_accuracy))</div><div class="line"></div><div class="line">        train_step.run(feed_dict={x: batch_data, y_: batch_labels, keep_prob: <span class="number">0.5</span>})</div><div class="line"></div><div class="line">    print(<span class="string">&quot;Test accuracy: %g&quot;</span> % accuracy.eval(feed_dict={</div><div class="line">        x: test_dataset, y_: test_labels, keep_prob: <span class="number">1.0</span>}))</div></pre></td></tr></table></figure></p>
<p>&#x8FD0;&#x884C;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8BC6;&#x522B;&#x7387;&#x5728;&#x4E0D;&#x65AD;&#x7684;&#x4E0A;&#x5347;&#x3002;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/train.png" alt="train"></p>
<p>&#x6700;&#x540E;&#xFF0C;&#x6709;&#x4E86;&#x63A5;&#x8FD1;98%&#x7684;&#x8BC6;&#x522B;&#x7387;&#xFF0C;&#x53EA;&#x6709;4000&#x4E2A;&#x8BAD;&#x7EC3;&#x6570;&#x636E;&#xFF0C;&#x611F;&#x89C9;&#x4E0D;&#x9519;&#x4E86;&#x3002;<br><img src="/2017/04/10/&#x4F7F;&#x7528;TensorFlow&#x8BAD;&#x7EC3;Weibo-cn&#x9A8C;&#x8BC1;&#x7801;/train_last.png" alt="train_last"></p>
</div></article></div></main><footer><div class="paginator"><a href="../../../09/18/那些年，我爬过的北科-序-——我和爬虫的缘分/" class="prev">PREV</a><a href="../../08/基于unoconv的在线office预览/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'seansun';
var disqus_identifier = '2017/04/10/使用TensorFlow训练Weibo-cn验证码/';
var disqus_title = '使用TensorFlow训练Weibo.cn验证码';
var disqus_url = 'http://nladuo.github.io/2017/04/10/使用TensorFlow训练Weibo-cn验证码/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//seansun.disqus.com/count.js" async></script><div class="copyright"><p>© 2015 - 2020 <a href="http://nladuo.github.io">叁公子KCN</a>, <a href="http://www.beian.miit.gov.cn/">京ICP备17062395号</a></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>